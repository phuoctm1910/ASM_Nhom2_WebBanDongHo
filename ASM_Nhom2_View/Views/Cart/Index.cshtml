@using Newtonsoft.Json;
@model ASM_Nhom2_View.Data.Bill
@using Microsoft.AspNetCore.Http
@{

    Layout = null;
    string FullName = Context.Session.GetString("FullName");
    string Email = Context.Session.GetString("Email");
    bool isLoggedIn = !string.IsNullOrEmpty(Email);
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cart</title>
    <!-- Bootstrap CSS v5.2.1 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!--Icon-->
    <script src="https://kit.fontawesome.com/b4d3d14cb1.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="~/css/cart.css" asp-append-version="true" />

</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg bg-white border" style="padding: 0!important;">
            <div class="row container-fluid p-0">
                <a class="navbar-brand col-2 text-center " asp-area="" asp-controller="Home" asp-action="Index">
                    <img src="~/images/logo.png" alt="logo" width="100px">
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                        aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse col-7" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link nav-home" asp-area="" asp-controller="Home" asp-action="About">Giới thiệu</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link nav-home" asp-area="" asp-controller="Home" asp-action="Contact">Liên hệ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link nav-home" asp-area="" asp-controller="Product" asp-action="Index">Sản phẩm</a>
                        </li>
                    </ul>
                    <form class="d-flex" role="search" style="width: 400px;">
                        <div class="input-group">
                            <input type="search" class="form-control" placeholder="Tìm kiếm"
                                   aria-describedby="button-addon2">
                            <button class="btn btn-outline-dark" type="submit" id="button-addon2">Search</button>
                        </div>
                    </form>
                </div>
                <div class="col-3 position-relative text-dark">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0 position-absolute text-black" style="left: 90px;top: -20px;">
                        <li class="nav-item dropdown d-flex nav-home">
                            @if (isLoggedIn)
                            {
                                <a class="nav-link dropdown-toggle text-start" role="button" data-bs-toggle="dropdown"
                                   aria-expanded="false">
                                    Hello, @FullName
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" asp-controller="User" asp-action="Chnageinfo">Đổi thông tin</a></li>
                                    <li><a class="dropdown-item" asp-controller="User" asp-action="Changepassword">Đổi mật khẩu</a></li>
                                    <li><a class="dropdown-item" asp-controller="User" asp-action="Logout">Đăng xuất</a></li>
                                </ul>
                            }
                            else
                            {
                                <a class="nav-link dropdown-toggle text-start" role="button" data-bs-toggle="dropdown"
                                   aria-expanded="false">
                                    Tài khoản
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" asp-controller="User" asp-action="Register">Đăng ký</a></li>
                                    <li><a class="dropdown-item" asp-controller="User" asp-action="Login">Đăng nhập</a></li>
                                    <li><a class="dropdown-item" asp-controller="User" asp-action="ForgotPassword">Quên mật khẩu</a></li>
                                </ul>
                            }


                            <hr />
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-end position-relative nav-home" role="button" asp-controller="Cart" asp-action="Index">
                                Giỏ hàng
                                <span class="position-absolute translate-middle badge rounded-pill bg-danger" style="top: 7px; right: -19px;">
                                    3
                                </span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>
    <div class="my-5">
        <main class="my-5">
            <div class="card">
                <div class="row">
                    <div class="col-md-8 cart">
                        <div class="title">
                            <div class="row">
                                <h4><b>Giỏ Hàng</b></h4>
                            </div>
                        </div>

                        @if (Model == null || !Model.BillDetails.Any())
                        {
                            <div class="row border-bottom">
                                <div class="row main align-items-center">
                                    <div class="col-2 text-dark">Ảnh</div>
                                    <div class="col">
                                        <div class="text-dark">Sản phẩm</div>
                                    </div>
                                    <div class="col">
                                        <div class="text-dark">Số lượng</div>
                                    </div>
                                    <div class="col">
                                        <div class="text-dark">Giá</div>
                                    </div>
                                    <div class="col">
                                        <div class="text-dark">Xóa</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row border-top border-bottom">
                                <div class="row main align-items-center">
                                    <div class="col-2">

                                    </div>
                                    <div class="col">
                                    </div>
                                    <div class="col productCount">
                                    </div>
                                    <div class="col">
                                    </div>
                                    <div class="col">
                                        <form asp-action="RemoveFromCart" asp-controller="Cart" method="post">
                                        </form>
                                    </div>
                                </div>
                            </div>

                        }
                        else
                        {
                            <div class="row border-bottom">
                                <div class="row main align-items-center">
                                    <div class="col-2 text-dark">Ảnh</div>
                                    <div class="col">
                                        <div class="text-dark">Sản phẩm</div>
                                    </div>
                                    <div class="col">
                                        <div class="text-dark">Số lượng</div>
                                    </div>
                                    <div class="col">
                                        <div class="text-dark">Giá</div>
                                    </div>
                                    <div class="col">
                                        <div class="text-dark">Xóa</div>
                                    </div>
                                </div>
                            </div>
                            @foreach (var item in Model.BillDetails)
                            {
                                <div class="row border-top border-bottom" id="billDetail-@item.Id">
                                    <div class="row main align-items-center">
                                        <div class="col-2">
                                            @{
                                                var productImages = item.Product.ProductImageList;
                                                var firstImage = productImages.First();
                                            }
                                            <img class="imgCart img-fluid" src="~/uploads/@firstImage">
                                        </div>
                                        <div class="col">
                                            <div class="row text-muted">@item.Product.ProductName</div>
                                        </div>
                                        <div class="col productCount">
                                            <button class="btn btn-outline-secondary decreaseQuantity" data-billdetail-id="@item.Id">-</button>
                                            <span class="quantity" data-quantity-id="@item.Id">@item.Quantity</span>
                                            <button class="btn btn-outline-secondary increaseQuantity" data-billdetail-id="@item.Id">+</button>
                                        </div>
                                        <div class="col price" data-price-id="@item.Id">@item.UnitPrice.ToString("C")</div>
                                        <div class="col">
                                            <button class="btn btn-danger deleteProductBtn" data-billdetail-id="@item.Id">X</button>
                                        </div>
                                    </div>
                                </div>


                            }
                        }
                    </div>
                    <div class="col-md-4 summary">
                        @if (Model != null && Model.BillDetails.Any())
                        {
                            <div>
                                <h5><b>Tổng kết</b></h5>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col text-center" style="padding-left:0;">Tổng <span id="totalQuantity">@Model.Quantity</span> sản phẩm</div>
                            </div>
                            <form class="formCart">
                                <p>Vận chuyển</p>
                                <select id="shippingOption">
                                    <option value="15000">Vận chuyển chậm - 15.000 ₫</option>
                                    <option value="25000">Vận chuyển nhanh - 25.000 ₫</option>
                                </select>
                                <p>Mã khuyến mãi</p>
                                <input class="input" id="code" placeholder="Nhập mã khuyến mãi">
                            </form>
                            <div class="row" style="border-top: 1px solid rgba(0,0,0,.1); padding: 2vh 0;">
                                <div class="col">Tổng giá sản phẩm:</div>
                                <div class="col text-right"><span id="subtotalAmount"></span></div>
                            </div>
                            <div class="row" style="border-top: 1px solid rgba(0,0,0,.1); padding: 2vh 0;">
                                <div class="col">Tổng giá:</div>
                                <div class="col text-right"><span id="totalAmount"></span></div>
                            </div>
                            <a asp-controller="Checkout" asp-action="Index" class="btnCart">Đặt hàng</a>


                        }
                        else
                        {
                            <div>
                                <h5><b>Tổng kết</b></h5>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col text-center" style="padding-left:0;">Tổng 0 sản phẩm</div>
                            </div>
                            <form class="formCart">
                                <p>Vận chuyển</p>
                                <select>
                                    <option class="text-muted">Vận chuyển chậm -  <span id="deli-slow">15.000</span>₫ </option>
                                    <option class="text-muted">Vận chuyển nhanh - <span id="deli-fast">25.000</span>₫</option>
                                </select>
                                <p>Mã khuyến mãi</p>
                                <input class="input" id="code" placeholder="Nhập mã khuyến mãi">
                            </form>
                            <div class="row" style="border-top: 1px solid rgba(0,0,0,.1); padding: 2vh 0;">
                                <div class="col">Tổng giá:</div>
                                <div class="col text-right"></div>
                            </div>
                            <button class="btnCart">Đặt hàng</button>
                        }
                    </div>
                </div>
            </div>
        </main>
    </div>
    <footer>
        <div class="text-white" style="background-color: #393939;">
            <div class="container lh-1 p-4">
                <div class="row">
                    <div class="col-md-3 col-sm-6">
                        <p class="fw-bold">NHỮNG THƯƠNG HIỆU</p>
                        <p>CASIO</p>
                        <p>LACOSTE</p>
                        <p>BULOVA</p>
                        <p>CALVIN KLEIN</p>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <p class="fw-bold">CÁC PHONG CÁCH ĐỒNG HỒ</p>
                        <p>THỂ THAO</p>
                        <p>SANG TRỌNG</p>
                        <p>CỔ ĐIỂN</p>
                        <p>THANH LỊCH</p>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <p class="fw-bold">THÔNG TIN CHUNG</p>
                        <p>CHÍNH SÁCH BẢO MẬT</p>
                        <p>ĐIỀU KHOẢN SỬ DỤNG</p>
                        <p>TƯ VẤN</p>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <p class="fw-bold">THEO DÕI</p>
                        <div class="d-flex" style="word-spacing: 10px;">
                            <a><img src="https://i.ibb.co/fXnhkLZ/icons8-zalo-32.png"></a>
                            <a class="mx-3"><img src="https://i.ibb.co/KGQpqKr/icons8-facebook-32.png"></a>
                            <a><img src="https://i.ibb.co/h8M2n9W/icons8-youtube-32.png"></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-white" style="font-size: 12px; background-color: #242323;">
            <div class="container lh-1 p-4">
                <span class="fs-6">
                    Copyright © 2024 WatchFives Group. All right reserved. Designed by Sudo |
                    nicedesign.works
                </span>
            </div>
        </div>

    </footer>
    <script src="~/lib/jquery/dist/jquery.min.js" asp-append-version="true"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script>
    $(document).ready(function () {
        $(window).scroll(function () {
            if ($(this).scrollTop() > 50) {
                $('.navbar').removeClass('sticky-top').addClass('fixed-top');
            } else {
                $('.navbar').removeClass('fixed-top').addClass('sticky-top');
            }
        });

        // Attach click event handler for delete buttons
        $('.deleteProductBtn').click(function () {
            var billDetailId = $(this).data('billdetail-id');
            removeProductFromBill(billDetailId);
        });

        // Attach click event handler for increase and decrease quantity buttons
        $('.increaseQuantity').click(function () {
            var billDetailId = $(this).data('billdetail-id');
            changeProductQuantity(billDetailId, 1);
        });

        $('.decreaseQuantity').click(function () {
            var billDetailId = $(this).data('billdetail-id');
            changeProductQuantity(billDetailId, -1);
        });

        // Event listener for shipping option change
        $('#shippingOption').change(function () {
            updateTotalAmount();
        });

        function removeProductFromBill(billDetailId) {
            $.ajax({
                url: '@Url.Action("RemoveFromCart", "Cart")',
                type: 'POST',
                data: { billDetailId: billDetailId },
                success: function (response) {
                    if (response.success) {
                        alert(response.message);
                        $(`#billDetail-${billDetailId}`).remove();
                        updateQuantityAndTotal();
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert('An error occurred while removing the product from the bill.');
                }
            });
        }

        function changeProductQuantity(billDetailId, change) {
            $.ajax({
                url: '@Url.Action("ChangeProductQuantity", "Cart")',
                type: 'POST',
                data: { billDetailId: billDetailId, change: change },
                success: function (response) {
                    if (response.success) {
                        var quantityElement = $(`#billDetail-${billDetailId} .quantity`);
                        var newQuantity = parseInt(quantityElement.text()) + change;
                        if (newQuantity > 0) {
                            quantityElement.text(newQuantity);
                            updateQuantityAndTotal();
                        } else {
                            $(`#billDetail-${billDetailId}`).remove();
                            updateQuantityAndTotal();
                        }
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert('An error occurred while changing the product quantity.');
                }
            });
        }

        function updateQuantityAndTotal() {
            var totalQuantity = 0;
            var totalAmount = 0;

            $('.productCount').each(function () {
                var quantity = parseInt($(this).find('.quantity').text());
                var price = parseFloat($(this).siblings('.price').text().replace(/[^\d.-]/g, ''));
                totalQuantity += quantity;
                totalAmount += quantity * price;
            });

            $('#totalQuantity').text(totalQuantity);
            $('#subtotalAmount').text(totalAmount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.') + ' ₫');

            updateTotalAmount(totalAmount);
        }

        function updateTotalAmount(subtotal) {
            var shippingCost = parseFloat($('#shippingOption').val());
            var finalAmount = subtotal + shippingCost;

            $('#totalAmount').text(finalAmount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.') + ' ₫');

            if ($('#totalQuantity').text() == '0') {
                $('#totalAmount').parent().hide();
            } else {
                $('#totalAmount').parent().show();
            }
        }

        updateQuantityAndTotal();
    });
    </script>


</body>
</html>

